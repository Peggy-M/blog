# å…³äºŽMVCC æœ¬èº«æ— æ³•è§£å†³å¹»è¯»é—®é¢˜

### 1. MVCC çš„ä½œç”¨

MVCC çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

- è¯»æ“ä½œä¸é˜»å¡žå†™æ“ä½œï¼Œå†™æ“ä½œä¹Ÿä¸é˜»å¡žè¯»æ“ä½œã€‚
- æ¯ä¸ªäº‹åŠ¡è¯»å–æ•°æ®æ—¶ï¼Œä¼šè¯»å–ä¸€ä¸ªå¿«ç…§ï¼ˆSnapshotï¼‰ï¼Œè€Œä¸æ˜¯ç›´æŽ¥è¯»â€œå½“å‰æœ€æ–°ç‰ˆæœ¬â€ã€‚
- è¿™æ ·å°±é¿å…äº†ï¼š
  - **è„è¯»**ï¼ˆè¯»åˆ°æœªæäº¤äº‹åŠ¡çš„æ•°æ®ï¼‰
  - **ä¸å¯é‡å¤è¯»**ï¼ˆåŒä¸€äº‹åŠ¡ä¸¤æ¬¡è¯»åŒä¸€æ¡è®°å½•ï¼Œç»“æžœä¸ä¸€æ ·ï¼‰

------

### 2. å¹»è¯»æ˜¯ä»€ä¹ˆ

å¹»è¯»å‘ç”Ÿåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œäº†**èŒƒå›´æŸ¥è¯¢**æ—¶ï¼š

- äº‹åŠ¡ T1ï¼š`SELECT * FROM orders WHERE amount > 100;`
- äº‹åŠ¡ T2ï¼šæ’å…¥ä¸€æ¡ `amount=200` çš„è®°å½•å¹¶æäº¤ã€‚
- äº‹åŠ¡ T1 å†æ¬¡æ‰§è¡Œç›¸åŒçš„ `SELECT`ï¼Œå‘çŽ°å¤šäº†ä¸€è¡Œæ•°æ®ã€‚

è¿™ç§â€œå¤šå‡ºæˆ–å‡å°‘çš„è¡Œâ€å°±æ˜¯ **å¹»è¯»**ã€‚

------

### 3. ä¸ºä»€ä¹ˆ MVCC è§£å†³ä¸äº†å¹»è¯»

å› ä¸º MVCC çš„å¿«ç…§**é’ˆå¯¹çš„æ˜¯å·²å­˜åœ¨çš„è®°å½•**ï¼Œå®ƒèƒ½ä¿è¯ä¸€è¡Œæ•°æ®åœ¨äº‹åŠ¡æœŸé—´ä¿æŒä¸€è‡´ï¼›
 ä½†å¯¹äºŽ**æ–°å¢žçš„è¡Œ**ï¼Œå®ƒæ˜¯æ— æ³•é˜»æ­¢çš„ã€‚

- æ¯”å¦‚äº‹åŠ¡ T2 æ’å…¥äº†æ–°è¡Œï¼ŒT1 çš„å¿«ç…§é‡Œæœ¬æ¥æ²¡æœ‰ï¼Œç­‰åˆ° T1 å†æŸ¥è¯¢ï¼Œå‘çŽ°â€œå‡ºçŽ°äº†ä¸€è¡Œå¹»å½±â€ã€‚

æ‰€ä»¥å•é  MVCCï¼Œåªèƒ½è§£å†³â€œè¡Œå†…å®¹å˜åŠ¨â€å¸¦æ¥çš„é—®é¢˜ï¼Œä½†è§£å†³ä¸äº†â€œè¡Œé›†åˆå‘ç”Ÿå˜åŒ–â€çš„æƒ…å†µã€‚

------

### 4. è§£å†³å¹»è¯»çš„æ–¹æ³•

æ•°æ®åº“ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š

1. **å¯é‡å¤è¯» + Next-Key Lockï¼ˆé—´éš™é”ï¼‰**
   - InnoDB åœ¨ **REPEATABLE READ** éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¦‚æžœæ¶‰åŠèŒƒå›´æŸ¥è¯¢ï¼Œå°±ä¼šåŠ  **Next-Key Lock**ï¼Œé”ä½æ•°æ®èŒƒå›´ï¼Œä¸å…è®¸åˆ«çš„äº‹åŠ¡å¾€è¿™ä¸ªèŒƒå›´é‡Œæ’å…¥æ–°è¡Œï¼Œä»Žè€Œé¿å…å¹»è¯»ã€‚
2. **Serializable éš”ç¦»çº§åˆ«**
   - æŠŠæ‰€æœ‰çš„è¯»éƒ½å½“æˆå†™æ¥å¤„ç†ï¼Œäº‹åŠ¡ä¹‹é—´å®Œå…¨ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œå½»åº•é¿å…å¹»è¯»ï¼Œä½†å¹¶å‘æ€§èƒ½æœ€å·®ã€‚

### 5. ä»€ä¹ˆæ˜¯é—´éš™é”ï¼ˆGap Lockï¼‰

- æ™®é€šè¡Œé”ï¼šé”ä½æŸä¸€è¡Œè®°å½•ï¼ˆæ¯”å¦‚ id=10ï¼‰ã€‚
- **é—´éš™é”**ï¼šé”ä½æŸä¸€è¡Œâ€œä¹‹é—´çš„ç©ºéš™â€ï¼ˆæ¯”å¦‚ (10,20) è¿™ä¸ªèŒƒå›´ï¼‰ï¼Œé˜²æ­¢åˆ«çš„äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´é‡Œæ’å…¥æ–°è¡Œã€‚
- **Next-Key Lock** = è¡Œé” + é—´éš™é”ã€‚

å®ƒçš„ä½œç”¨å°±æ˜¯ï¼š**é˜²æ­¢å¹»è¯»**ã€‚

### 6.åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ InnoDB ä¼šåŠ é—´éš™é”

1. **äº‹åŠ¡éš”ç¦»çº§åˆ«å¿…é¡»æ˜¯ REPEATABLE READ æˆ–æ›´é«˜ï¼ˆSerializableï¼‰**

   - åœ¨ READ COMMITTED ä¸‹ï¼Œé—´éš™é”ä¸€èˆ¬ä¸ä¼šç”Ÿæ•ˆã€‚

2. **æ‰§è¡ŒèŒƒå›´æŸ¥è¯¢æ—¶**
    ä¾‹å¦‚ï¼š

   ```
   BEGIN;
   SELECT * FROM users WHERE age BETWEEN 10 AND 20 FOR UPDATE;
   ```

   è¿™æ—¶ InnoDB ä¼šé”ä½ `age` åœ¨ (10,20) åŒºé—´çš„å·²æœ‰è¡Œï¼Œå¹¶ä¸”åŠ ä¸Š **é—´éš™é”**ï¼Œç¦æ­¢åˆ«çš„äº‹åŠ¡åœ¨è¿™ä¸ªèŒƒå›´æ’å…¥æ–°çš„ age=15 çš„ç”¨æˆ·ã€‚

3. **å”¯ä¸€ç´¢å¼•å¤±æ•ˆæ—¶**
    å¦‚æžœæ¡ä»¶ä¸æ˜¯ç²¾ç¡®ç­‰å€¼æŸ¥è¯¢ï¼Œè€Œæ˜¯èŒƒå›´ã€æ¨¡ç³Šæˆ–è€…æ²¡æœ‰ç”¨ä¸Šç´¢å¼•ï¼Œä¹Ÿä¼šè§¦å‘é—´éš™é”ã€‚

### 7. å¦‚ä½•â€œæ·»åŠ â€é—´éš™é”ï¼ˆå®žæ“ï¼‰

ðŸ‘‰ å…³é”®æ˜¯ **è¯­å¥ + äº‹åŠ¡éš”ç¦»çº§åˆ«**ã€‚

### ä¾‹å­ï¼šé˜²æ­¢å¹»è¯»

å¯¹çš„ âœ…ï¼Œä½ å†™çš„è¿™ä¸‰è¡Œç¡®å®žå¯ä»¥è§¦å‘ **é—´éš™é”ï¼ˆGap Lockï¼‰**ï¼Œä½†æœ‰å‡ ä¸ªç»†èŠ‚è¦æ³¨æ„ï¼Œæˆ‘ç»™ä½ å®Œæ•´è§£é‡Šä¸€ä¸‹ï¼š

**ä½ çš„è¯­å¥åšäº†ä»€ä¹ˆ**

```sql
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
SELECT * FROM orders WHERE amount > 100 FOR UPDATE;
```

- `SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;`
   è®¾ç½®æœ¬ä¼šè¯çš„éš”ç¦»çº§åˆ«ä¸º **å¯é‡å¤è¯»**ã€‚è¿™æ˜¯ InnoDB è§¦å‘é—´éš™é”çš„å‰æã€‚
- `BEGIN;`
   å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚
- `SELECT * FROM orders WHERE amount > 100 FOR UPDATE;`
   è¿™æ˜¯ä¸€ä¸ª**èŒƒå›´æŸ¥è¯¢** + **é”å®šè¯»**ã€‚
   InnoDB ä¼šï¼š
  - é”ä½æ‰€æœ‰ `amount > 100` çš„å·²æœ‰è¡Œï¼ˆè¡Œé”ï¼‰ã€‚
  - åœ¨è¿™äº›è¡Œçš„â€œé—´éš™â€ä¸ŠåŠ  **é—´éš™é”**ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ `amount` åœ¨èŒƒå›´å†…çš„æ–°è®°å½•ã€‚

**ä»€ä¹ˆæ—¶å€™è§¦å‘é—´éš™é”**

ä½ çš„è¯­å¥å¯ä»¥è§¦å‘ï¼Œä½†è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š

1. **å¿…é¡»æœ‰ç´¢å¼•**ï¼š
   - å¦‚æžœ `amount` ä¸Šæœ‰ç´¢å¼•ï¼ˆæœ€å¥½æ˜¯ B+æ ‘ç´¢å¼•ï¼‰ï¼Œå°±èƒ½ç²¾ç¡®åœ°åœ¨ç´¢å¼•èŒƒå›´ä¸ŠåŠ  gap lockã€‚
   - å¦‚æžœæ²¡æœ‰ç´¢å¼•ï¼ŒInnoDB ä¼šé”æ•´å¼ è¡¨ï¼ˆå…¨è¡¨æ‰«æ + æ„å¤–çš„å¤§èŒƒå›´é—´éš™é”ï¼‰ã€‚
2. **å¿…é¡»æ˜¯èŒƒå›´æŸ¥è¯¢**ï¼š
   - `>`, `<`, `BETWEEN`ï¼Œè¿™äº›ä¼šè§¦å‘é—´éš™é”ã€‚
   - ç²¾ç¡®åŒ¹é…ï¼ˆ`WHERE amount = 100` ä¸”æœ‰å”¯ä¸€ç´¢å¼•ï¼‰ä¸ä¼šè§¦å‘é—´éš™é”ï¼Œåªä¼šé”è¡Œã€‚
3. **éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE READ**ï¼š
   - åœ¨ READ COMMITTED ä¸‹ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ä¼šåŠ  gap lockã€‚

### 8. æ‰‹åŠ¨éªŒè¯é—´éš™é”æ˜¯å¦ç”Ÿæ•ˆ

1. æŸ¥çœ‹äº‹åŠ¡ä¿¡æ¯ï¼š

   ```
   SELECT * FROM information_schema.innodb_locks;
   ```

2. ä½ ä¼šçœ‹åˆ°é”çš„ç±»åž‹é‡Œå‡ºçŽ° `GAP` æˆ– `NEXT-KEY`ã€‚