# 基于 Redis 的短链接系统设计方案

好的，我来帮你梳理一下 **基于 Redis 的短链接系统设计方案**。这个系统的核心目标是：

1. 输入一个长链接，生成一个短链接（短码）。
2. 输入短码，快速还原为原始长链接。
3. 支持高并发、低延迟，并具备一定的扩展性和防止冲突机制。

------

## 一、基本流程

1. **长链接 → 短码**
   - 用户输入长链接。
   - 系统生成一个短码（6~8 位）。
   - 存入 Redis，`key=短码, value=长链接`。
2. **短码 → 长链接**
   - 用户访问 `http://t.cn/abc123`。
   - 系统查询 Redis，找到对应长链接，重定向跳转。

------

## 二、核心设计点

### 1. 短码生成策略

几种常见方式：

- **自增 ID + Base62 编码**
  - 使用 Redis 的 `INCR` 得到全局自增 ID。
  - 将 ID 转换为 [0-9a-zA-Z] 的 62 进制字符串。
  - 例如：1 → "b", 10000 → "qwe"。
  - 优点：无冲突，顺序增长；缺点：短码可被推测。
- **哈希生成 (MD5/SHA1 + 截取)**
  - 对长链接做哈希（MD5/SHA1）。
  - 取前 6-8 位作为短码。
  - 可能冲突，需要用 Redis 的 `SETNX` 检测。
- **随机生成**
  - 随机生成 6~8 位短码，SETNX 确保唯一。
  - 优点：不可预测，安全性高；缺点：可能多次尝试才成功。

👉 一般推荐 **自增 ID + Base62**，既高效又避免冲突。

------

### 2. Redis 数据结构设计

- **字符串存储**

  ```bash
  SET short:abc123 https://www.example.com/long/url/xxxxx
  ```

- **反向映射（可选）**

  ```bash
  SET long:https://www.example.com/long/url/xxxxx abc123
  ```

  （防止重复生成短码，节省存储）

- **过期时间（可选）**

  ```bash
  SETEX short:abc123 2592000 https://example.com   # 30 天过期
  ```

------

### 3. 并发与原子性

- 使用 `INCR` 或 `SETNX` 保证生成短码时的原子性。
- 若采用随机/哈希方式，必须 `SETNX` 防止 key 覆盖。

------

### 4. 系统架构

1. **入口服务 (API 网关)**
   - 负责接收长链接，调用短链服务。
2. **短链服务**
   - 生成短码并存储到 Redis。
   - 提供解析短码的接口。
3. **Redis 缓存层**
   - 高速 KV 存储，支持高并发查询。
4. **持久化（可选）**
   - 将短码映射定期写入 MySQL/ES，避免 Redis 宕机数据丢失。

------

### 5. 优化点

- **热点数据优化**：
   热门短链可设置更长的 TTL 或持久化到本地缓存（如 Guava、Caffeine）。

- **访问统计**：
   使用 Redis `INCR` 记录访问次数，例如：

  ```bash
  INCR click:abc123
  ```

- **多机部署**：

  - Redis 可使用 **Cluster** 模式分片存储。
  - 短码生成可通过 **Snowflake ID / Redis INCR** 保证全局唯一。